/**
 * Swagger UI JavaScript ë¡œì§
 */

let swaggerUI = null;
let availableServices = {};

// Swagger UI ì´ˆê¸°í™”
function initSwaggerUI(specUrl, title = "API Documentation") {
    const ui = SwaggerUIBundle({
        url: specUrl,
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [
            SwaggerUIBundle.presets.apis,
            SwaggerUIStandalonePreset
        ],
        plugins: [
            SwaggerUIBundle.plugins.DownloadUrl
        ],
        layout: "StandaloneLayout",
        // UI ê°œì„ : ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
        displayOperationId: false,
        showExtensions: false,
        showCommonExtensions: false,
        tryItOutEnabled: true,
        tryItOutEnabled: true,
        requestInterceptor: (request) => {
            console.log("ğŸ” Request Interceptor - Original request:", request.url);
            
            // Swagger ê´€ë ¨ ìš”ì²­ì€ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•ŠìŒ
            if (request.url.includes('/swagger/')) {
                console.log("â­ï¸ Skipping swagger request:", request.url);
                return request;
            }
            
            // OpenAPI ìŠ¤í™ ìš”ì²­ë„ í”„ë¡ì‹œë¥¼ ê±°ì¹˜ì§€ ì•ŠìŒ  
            if (request.url.includes('openapi.json') || request.url.includes('/spec')) {
                console.log("â­ï¸ Skipping spec request:", request.url);
                return request;
            }
            
            // API í”„ë¡ì‹œë¥¼ í†µí•´ ìš”ì²­ ë¼ìš°íŒ…
            if (request.url.startsWith('/api/proxy/')) {
                console.log("âœ… Already proxy URL:", request.url);
                return request;
            }
            
            // API v1 ê²½ë¡œì¸ ê²½ìš° ì„œë¹„ìŠ¤ëª…ì„ ì¶”ì¶œí•´ì„œ í”„ë¡ì‹œ ê²½ë¡œë¡œ ë³€í™˜ (ìƒëŒ€/ì ˆëŒ€ ê²½ë¡œ ëª¨ë‘ ì²˜ë¦¬)
            if (request.url.includes('/api/v1/')) {
                let pathToConvert = request.url;
                let baseUrl = '';
                
                // ì ˆëŒ€ URLì¸ ê²½ìš° ê²½ë¡œ ë¶€ë¶„ë§Œ ì¶”ì¶œ
                if (request.url.startsWith('http')) {
                    const urlObj = new URL(request.url);
                    pathToConvert = urlObj.pathname + urlObj.search;
                    baseUrl = urlObj.origin;
                }
                
                const serviceName = extractServiceFromPath(pathToConvert);
                console.log("ğŸ”„ Extracting service name from:", pathToConvert, "-> Service:", serviceName);
                
                if (serviceName) {
                    // ì´ˆë‹¨ì¶• URL: /api/{resource}/ í˜•íƒœë¡œ ë³€í™˜
                    let resourcePath = pathToConvert.replace(/^\/api\/v\d+\//, '/');
                    const newUrl = baseUrl + `/api${resourcePath}`;
                    console.log("ğŸš€ Converting URL:", request.url, "->", newUrl);
                    console.log("ğŸ“ Ultra-shortened URL - Original:", pathToConvert, "-> Final:", `/api${resourcePath}`);
                    request.url = newUrl;
                }
            }
            
            console.log("ğŸ“¤ Final request URL:", request.url);
            return request;
        },
        onComplete: () => {
            hideLoading();
            
            // ê¸°ë³¸ Swagger UI í—¤ë”ì— ë™ì  ì„œë¹„ìŠ¤ ì •ë³´ ì¶”ê°€
            setTimeout(() => {
                // information-containerì˜ padding ê°•ì œë¡œ ì œê±°
                const infoContainers = document.querySelectorAll('.information-container, .information-container.wrapper, .wrapper.information-container');
                infoContainers.forEach(container => {
                    container.style.setProperty('padding', '0', 'important');
                    container.style.setProperty('padding-top', '0', 'important');
                    container.style.setProperty('padding-bottom', '0', 'important');
                    container.style.setProperty('padding-left', '0', 'important');
                    container.style.setProperty('padding-right', '0', 'important');
                    container.style.setProperty('margin', '0', 'important');
                });
                
                updateDefaultSwaggerHeader();
                console.log("âœ… Default Swagger UI header updated");
                
                // ì£¼ê¸°ì ìœ¼ë¡œ í—¤ë” ì—…ë°ì´íŠ¸ (ë™ì  ë¡œë”© ëŒ€ì‘)
                const updateInterval = setInterval(() => {
                    const infoContainer = document.querySelector('.swagger-ui .information-container .info');
                    if (infoContainer && !infoContainer.querySelector('.service-info-extra')) {
                        updateDefaultSwaggerHeader();
                    }
                }, 1000);
                
                // 5ì´ˆ í›„ ì¸í„°ë²Œ ì •ë¦¬
                setTimeout(() => clearInterval(updateInterval), 5000);
                
                // ë‚˜ë¨¸ì§€ ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
                const unwantedSelectors = [
                    '.swagger-ui .topbar',
                    '.swagger-ui .authorization__btn',
                    '.swagger-ui .auth-wrapper',
                    '.swagger-ui .scheme-container',
                    '.swagger-ui .models',
                    '.swagger-ui .model-container',
                    '.swagger-ui .model',
                    '.swagger-ui .model-toggle',
                    '.swagger-ui .model-box',
                    '.swagger-ui .model-box-control',
                    '.swagger-ui .models-control',
                    '.swagger-ui .invalid',
                    '.swagger-ui .validation-errors',
                    '.swagger-ui .response-schema',
                    '.swagger-ui table.model',
                    '.swagger-ui .property-row',
                    '.swagger-ui .download-contents',
                    '.swagger-ui .copy-to-clipboard'
                ];
                
                unwantedSelectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        el.style.display = 'none';
                        console.log("ğŸ§¹ Hidden schema/model element:", selector);
                    });
                });
                
                // API ì„¹ì…˜ë“¤ì€ í™•ì‹¤íˆ í‘œì‹œ
                const apiSections = document.querySelectorAll('.swagger-ui .opblock, .swagger-ui .opblock-tag');
                apiSections.forEach(el => {
                    el.style.display = 'block';
                    el.style.visibility = 'visible';
                });
                
                console.log("âœ… Custom header layout complete");
                
                // ì£¼ê¸°ì ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ìš”ì†Œë“¤ì„ ì œê±° (Swagger UIê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                const cleanUpInterval = setInterval(() => {
                    const dynamicUnwantedSelectors = [
                        '.swagger-ui .models',
                        '.swagger-ui .model',
                        '.swagger-ui .invalid',
                        '.swagger-ui .btn.invalid',
                        '.swagger-ui table.model',
                        '.swagger-ui .model-container',
                        '.swagger-ui .response-schema',
                        '.swagger-ui .model-toggle',
                        '.swagger-ui .model-box',
                        '.swagger-ui .model-box-control',
                        '.swagger-ui .scheme-container .model-toggle',
                        'button[title*="invalid" i]',
                        'button[title*="model" i]'
                    ];
                    
                    let found = false;
                    dynamicUnwantedSelectors.forEach(selector => {
                        const elements = document.querySelectorAll(selector);
                        if (elements.length > 0) {
                            elements.forEach(el => {
                                el.style.display = 'none';
                                el.style.visibility = 'hidden';
                                el.remove();
                                found = true;
                            });
                        }
                    });
                    
                    // INVALID í…ìŠ¤íŠ¸ê°€ í¬í•¨ëœ ëª¨ë“  ë²„íŠ¼ ì œê±° (ë” ê°•ë ¥í•˜ê²Œ)
                    const allButtons = document.querySelectorAll('button, .btn, [class*="btn"], [class*="button"]');
                    allButtons.forEach(btn => {
                        const text = (btn.textContent || btn.innerText || '').trim();
                        const ariaLabel = (btn.getAttribute('aria-label') || '').toUpperCase();
                        const title = (btn.getAttribute('title') || '').toUpperCase();
                        
                        if (text.toUpperCase().includes('INVALID') || 
                            ariaLabel.includes('INVALID') ||
                            title.includes('INVALID') ||
                            btn.classList.contains('invalid') ||
                            btn.classList.toString().toUpperCase().includes('INVALID')) {
                            btn.style.display = 'none';
                            btn.style.visibility = 'hidden';
                            btn.style.opacity = '0';
                            btn.style.position = 'absolute';
                            btn.style.left = '-9999px';
                            btn.remove();
                            found = true;
                        }
                    });
                    
                    // {} ì•„ì´ì½˜ì´ ìˆëŠ” ë²„íŠ¼ë„ ì œê±°
                    const allElements = document.querySelectorAll('*');
                    allElements.forEach(el => {
                        const text = (el.textContent || el.innerText || '').trim();
                        if ((text === '{}' || text === '{ }' || text.includes('INVALID')) && 
                            (el.tagName === 'BUTTON' || el.classList.contains('btn') || el.getAttribute('role') === 'button')) {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.remove();
                            found = true;
                        }
                    });
                    
                    if (found) {
                        console.log("ğŸ§¹ Cleaned up dynamically added unwanted elements");
                    }
                }, 500);
                
                // 10ì´ˆ í›„ ì¸í„°ë²Œ ì •ë¦¬
                setTimeout(() => {
                    clearInterval(cleanUpInterval);
                    console.log("âœ… Cleanup interval stopped");
                }, 10000);
                
            }, 200);
        },
        onFailure: (err) => {
            console.error('Swagger UI failed to load:', err);
            showError('API ìŠ¤í™ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
            hideLoading();
        }
    });
    
    return ui;
}

// URLì—ì„œ ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ
function getServiceFromUrl(url) {
    try {
        const urlObj = new URL(url);
        const hostname = urlObj.hostname;
        // k8s ì„œë¹„ìŠ¤ëª… í˜•íƒœì¸ì§€ í™•ì¸ (service-name.namespace.svc.cluster.local)
        if (hostname.includes('.')) {
            return hostname.split('.')[0];
        }
        return hostname;
    } catch (e) {
        return 'unknown';
    }
}

// URLì—ì„œ ê²½ë¡œ ì¶”ì¶œ
function getPathFromUrl(url) {
    try {
        const urlObj = new URL(url);
        return urlObj.pathname + urlObj.search;
    } catch (e) {
        return '/';
    }
}

// API ê²½ë¡œì—ì„œ ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ
function extractServiceFromPath(path) {
    // /api/v1/aggregation/ -> aggregation-service
    // /api/v1/location/ -> location-service  
    // /api/v1/realtime/ -> realtime-service
    // /api/v1/thresholds/ -> thresholds-service
    
    const pathSegments = path.split('/').filter(seg => seg);
    if (pathSegments.length >= 3 && pathSegments[0] === 'api' && pathSegments[1] === 'v1') {
        const servicePath = pathSegments[2];
        
        // ì„œë¹„ìŠ¤ëª… ë§¤í•‘
        const serviceMapping = {
            'aggregation': 'aggregation-service',
            'location': 'location-service', 
            'realtime': 'realtime-service',
            'thresholds': 'thresholds-service'
        };
        
        return serviceMapping[servicePath] || servicePath;
    }
    
    return null;
}

// ì„œë¹„ìŠ¤ ëª©ë¡ ë¡œë“œ
async function loadServices() {
    try {
        const response = await fetch('/api/v1/swagger/services');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const data = await response.json();
        availableServices = data.services || {};
        
        updateServiceSelector();
        updateServiceCount();
        updateDefaultSwaggerHeader();
        
    } catch (error) {
        console.error('Failed to load services:', error);
        showError('Failed to load service list: ' + error.message);
    }
}

// Swagger ê¸°ë³¸ í—¤ë”ì— ë™ì  ì„œë¹„ìŠ¤ ì •ë³´ ì¶”ê°€
function updateDefaultSwaggerHeader() {
    try {
        const infoContainer = document.querySelector('.swagger-ui .information-container .info');
        if (!infoContainer) {
            console.warn('âš ï¸ Swagger info container not found');
            return;
        }
        
        // ê¸°ì¡´ ì„œë¹„ìŠ¤ ì •ë³´ ìš”ì†Œ ì œê±° (ì¤‘ë³µ ë°©ì§€)
        const existingExtra = infoContainer.querySelector('.service-info-extra');
        if (existingExtra) {
            existingExtra.remove();
        }
        
        // ì¤‘ë³µë˜ëŠ” contact, link, servers ì •ë³´ ìˆ¨ê¸°ê¸°
        const contact = infoContainer.querySelector('.info__contact');
        if (contact) contact.style.display = 'none';
        
        const link = infoContainer.querySelector('.link');
        if (link) link.style.display = 'none';
        
        // base-urlì´ë‚˜ servers ì •ë³´ë„ ìˆ¨ê¸°ê¸°
        const baseUrl = infoContainer.querySelector('.base-url');
        if (baseUrl) baseUrl.style.display = 'none';
        
        const serviceNames = Object.keys(availableServices).filter(name => {
            const service = availableServices[name];
            return service && service.is_available;
        });
        
        const count = serviceNames.length;
        
        // description ë‚´ìš© ì—…ë°ì´íŠ¸ (ì„œë¹„ìŠ¤ ê°œìˆ˜ í‘œì‹œ) - ì¤‘ì•™ ì •ë ¬
        const description = infoContainer.querySelector('.description');
        if (description) {
            description.textContent = `Total ${count} microservices integrated API documentation`;
            description.style.textAlign = 'center';
            description.style.width = '100%';
        }
        
        // ì„œë¹„ìŠ¤ ëª©ë¡ë§Œ ì¶”ê°€ (ì¤‘ì•™ ì •ë ¬)
        const serviceInfoDiv = document.createElement('div');
        serviceInfoDiv.className = 'service-info-extra';
        serviceInfoDiv.innerHTML = `
            <p style="margin: 0; text-align: center; width: 100%;">
                <strong>Included services:</strong> <span id="service-list">${serviceNames.length > 0 ? serviceNames.join(', ') : 'Loading...'}</span>
            </p>
        `;
        
        // description ë’¤ì— ì¶”ê°€
        if (description) {
            description.insertAdjacentElement('afterend', serviceInfoDiv);
        } else {
            // descriptionì´ ì—†ìœ¼ë©´ title ë’¤ì— ì¶”ê°€
            const title = infoContainer.querySelector('.title');
            if (title) {
                title.insertAdjacentElement('afterend', serviceInfoDiv);
            }
        }
        
        console.log(`âœ… Default Swagger header updated: ${count} microservices`);
    } catch (error) {
        console.error('Failed to update default Swagger header:', error);
    }
}

// í—¤ë”ì˜ ì„œë¹„ìŠ¤ ì •ë³´ ì—…ë°ì´íŠ¸ (ë ˆê±°ì‹œ í˜¸í™˜ì„±)
function updateHeaderServiceInfo() {
    updateDefaultSwaggerHeader();
}

// ì„œë¹„ìŠ¤ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
function updateServiceSelector() {
    const select = document.getElementById('service-select');
    
    // service-select ìš”ì†Œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    if (!select) {
        console.log('âš ï¸ service-select element not found, skipping');
        return;
    }
    
    // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ í†µí•© ì˜µì…˜ ì œì™¸)
    while (select.children.length > 1) {
        select.removeChild(select.lastChild);
    }
    
    // ì„œë¹„ìŠ¤ë³„ ì˜µì…˜ ì¶”ê°€
    Object.entries(availableServices).forEach(([serviceName, spec]) => {
        const option = document.createElement('option');
        option.value = serviceName;
        
        if (spec.is_available) {
            option.textContent = `ğŸ“‹ ${spec.title} (v${spec.version})`;
        } else {
            option.textContent = `âŒ ${serviceName} (unavailable)`;
            option.disabled = true;
        }
        
        select.appendChild(option);
    });
}

// ì„œë¹„ìŠ¤ ê°œìˆ˜ ì—…ë°ì´íŠ¸
function updateServiceCount() {
    const serviceCount = document.getElementById('service-count');
    if (!serviceCount) {
        // service-count ìš”ì†Œê°€ ì—†ìœ¼ë©´ ìŠ¤í‚µ
        return;
    }
    
    const available = Object.values(availableServices).filter(s => s.is_available).length;
    const total = Object.keys(availableServices).length;
    serviceCount.textContent = `${available}/${total} available microservices`;
}

// ì„ íƒëœ ì„œë¹„ìŠ¤ì˜ API ìŠ¤í™ ë¡œë“œ
async function loadSelectedService() {
    const select = document.getElementById('service-select');
    const selectedService = select.value;
    
    clearError();
    clearServiceInfo();
    showLoading();
    
    try {
        let specUrl;
        let title;
        
        if (selectedService === 'integrated') {
            specUrl = '/openapi.json';
            title = 'Felt Montrg API Documentation';
            showServiceInfo({
                title: 'Felt Montrg API Documentation',
                description: `Total ${Object.values(availableServices).filter(s => s.is_available).length} microservices integrated API`,
                version: '1.0.0',
                services: Object.keys(availableServices).filter(name => availableServices[name].is_available)
            });
        } else {
            specUrl = `/api/v1/swagger/services/${selectedService}/spec`;
            const serviceSpec = availableServices[selectedService];
            title = serviceSpec ? serviceSpec.title : selectedService;
            
            if (serviceSpec) {
                showServiceInfo(serviceSpec);
            }
            
            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸
            console.log(`Loading service spec: ${selectedService}`);
            console.log(`Spec URL: ${specUrl}`);
        }
        
        // Swagger UI ë‹¤ì‹œ ì´ˆê¸°í™”
        swaggerUI = initSwaggerUI(specUrl, title);
        
    } catch (error) {
        console.error('Failed to load service spec:', error);
        showError('Failed to load API specification: ' + error.message);
        hideLoading();
    }
}

// ì„œë¹„ìŠ¤ ì •ë³´ í‘œì‹œ
function showServiceInfo(info) {
    const container = document.getElementById('service-info-container');
    
    let servicesText = '';
    if (info.services && info.services.length > 0) {
        servicesText = `<p><strong>Included services:</strong> ${info.services.join(', ')}</p>`;
    }
    
    container.innerHTML = `
        <div class="service-info">
            <h3>${info.title}</h3>
            <p><strong>Version:</strong> ${info.version}</p>
            <p><strong>Description:</strong> ${info.description || 'API documentation'}</p>
            ${servicesText}
        </div>
    `;
}

function clearServiceInfo() {
    document.getElementById('service-info-container').innerHTML = '';
}

// API ìŠ¤í™ ìƒˆë¡œê³ ì¹¨
async function refreshSpecs() {
    showLoading();
    clearError();
    
    try {
        // ì„œë²„ì—ì„œ ìŠ¤í™ ìƒˆë¡œê³ ì¹¨ ìš”ì²­
        const response = await fetch('/api/v1/swagger/refresh', { method: 'POST' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // ì„œë¹„ìŠ¤ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ (í—¤ë” ì •ë³´ë„ ì—…ë°ì´íŠ¸ë¨)
        await loadServices();
        
        // í˜„ì¬ ì„ íƒëœ ì„œë¹„ìŠ¤ ë‹¤ì‹œ ë¡œë“œ
        const serviceSelect = document.getElementById('service-select');
        if (serviceSelect) {
            await loadSelectedService();
        } else {
            // ì„œë¹„ìŠ¤ ì„ íƒì´ ì—†ìœ¼ë©´ Swagger UIë§Œ ë‹¤ì‹œ ì´ˆê¸°í™”
            swaggerUI = initSwaggerUI('/openapi.json', 'Felt Montrg API Documentation');
        }
        
        console.log('API specs refreshed successfully');
        
    } catch (error) {
        console.error('Failed to refresh specs:', error);
        showError('Failed to refresh API specification: ' + error.message);
    } finally {
        hideLoading();
    }
}

// UI ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function showLoading() {
    document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading').style.display = 'none';
}

function showError(message) {
    const container = document.getElementById('error-container');
    container.innerHTML = `<div class="error">${message}</div>`;
}

function clearError() {
    document.getElementById('error-container').innerHTML = '';
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸš€ Initializing Swagger UI...');
    
    // ì„œë¹„ìŠ¤ ì„ íƒ ìš”ì†Œê°€ ìˆìœ¼ë©´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const serviceSelect = document.getElementById('service-select');
    if (serviceSelect) {
        serviceSelect.addEventListener('change', loadSelectedService);
        console.log('âœ… Service selector found and event listener attached');
    } else {
        console.warn('âš ï¸ Service selector not found, skipping service selection feature');
    }
    
    // ì„œë¹„ìŠ¤ ëª©ë¡ ë¨¼ì € ë¡œë“œ (í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
    try {
        await loadServices();
    } catch (error) {
        console.warn('âš ï¸ Failed to load services list:', error);
    }
    
    // í†µí•© API ìŠ¤í™ ë¡œë“œ (ê¸°ë³¸ê°’)
    try {
        showLoading();
        console.log('ğŸ“¡ Loading integrated API spec from /openapi.json...');
        swaggerUI = initSwaggerUI('/openapi.json', 'Felt Montrg API Documentation');
        console.log('âœ… Swagger UI initialized');
    } catch (error) {
        console.error('âŒ Failed to initialize Swagger UI:', error);
        showError('Failed to load API specification: ' + error.message);
        hideLoading();
    }
});